<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
	
	<link rel="stylesheet" href="css/reset.css" media="all">
	<link rel="stylesheet" href="css/screen.css" media="all">
		
	
	
</head>
<body>




<script>
		
		    var coords = {lat: "", lon: ""};
    var w;
    var date = new Date();
    var tod = date.getDay();

    if(navigator.geolocation) {
       navigator.geolocation.getCurrentPosition(getPosition, error);
    } else {
        alert("No geolocation available in your browser.");
    }

    function error() {
        alert("Failed to load geolocation data.");
    }

    var weekdays=new Array();
        weekdays[0]="Sunday";
        weekdays[1]="Monday";
        weekdays[2]="Tuesday";
        weekdays[3]="Wednesday";
        weekdays[4]="Thursday";
        weekdays[5]="Friday";
        weekdays[6]="Saturday";


      var list = $("a");
    list.each(function(index){
        $(this).on("click", function(){w.show(index);});
    });

    function getPosition(position) {
       coords.lat = position.coords.latitude;
       coords.lon = position.coords.longitude;
        w= new Weather(coords.lat, coords.lon);
    }


var Weather = function(lat, lon) {
    this.latitude = lat;
    this.longitude = lon;
    this.key= "597df09d068541c0d8e9e6d6c5b29ff7";
    this.weatherData;
    this.checkStorage();
}

Weather.prototype.loadData = function() {
    var jsonurl = "https://api.forecast.io/forecast/"+this.key+"/"+this.latitude+","+this.longitude;
    $.ajax({url: jsonurl, type: "GET", dataType: "jsonp"})
    .done(function(data) {
        console.log("saving to storage");
        //console.log(data);
        this.weatherData = data;
        localStorage.setItem("weather", JSON.stringify(this.weatherData));
        localStorage.setItem("time",new Date().getTime());
        w.checkStorage();
    });
}

Weather.prototype.checkStorage = function() {
    console.log("checking localstorage");
    if(!localStorage.getItem("weather")) {
        this.loadData();
    } else {
        console.log("Storage checked, OK");
        if(new Date().getTime() - localStorage.getItem("time")<= 3600000) {
            this.weatherData = JSON.parse(localStorage.getItem("weather"));
            console.log("Storage is last version");
            this.show(0);
        } else {
            console.log("Out of date, reloading data");
            this.loadData();
        }
    }
}

Weather.prototype.show = function(number) { 
        var dailyWeather = this.weatherData.daily.data[number];
        this.render(dailyWeather);
}

Weather.prototype.updateLocation = function(lat, lon) {
    this.latitude = lat;
    this.longitude = lon;
    this.loadData();
}

Weather.prototype.clearStorage = function () {
    localStorage.setItem("weather","");
}





</script>
</body>
</html>